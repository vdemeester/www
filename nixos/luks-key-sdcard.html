<!DOCTYPE html>
<html lang="en">
<head>
<!-- Sep 03, 2024 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Automatically unlock a luks encrypted partiiton with an SDCard</title>
<meta name="author" content="Vincent Demeester" />
<meta name="keywords" content="post" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/css/2022.css" />
<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Automatically unlock a luks encrypted partiiton with an SDCard</h1>
<p class="subtitle" role="doc-subtitle">… or a USB card.</p>
</header><p>
I am booting my work laptop (NixOS on a Thinkpad) from a LUKS-encrypted volume. I also do
have another &ldquo;laptop&rdquo; (used as a build/server) that is LUKS-encrypted. So far, I&rsquo;ve been
using a passphrase I type on boot. It&rsquo;s more than fine for my laptop, but it means it&rsquo;s a
bit trickier for my other machine. I need to remove from its slot below my desk, type it
and re-put it in the slot. This mean it&rsquo;s a bit harder to do upgrade and reboot without
any input from me.
</p>

<p>
For convenience, I want an SD card&rsquo;s LUKS volume to unlock and mount when the machine
boots, rather than me needing to unlock and mount it each time.
</p>

<p>
There is a bunch of articles about this, like <a href="https://possiblelossofprecision.net/?p=300">this one</a>. Or slightly related <a href="https://kyau.net/wiki/ArchLinux:LUKS">these</a> <a href="https://neilzone.co.uk/2021/07/auto-unlocking-a-luks-volume-on-an-sd-card-on-boot-with-debian-11-bullseye">ones</a>. I
am using NixOS however, and it is actually making things relatively straightforward. The
closer article to what I was looking for is <a href="https://medium.com/@geis/using-a-raw-usb-device-to-unlock-a-luks-volume-on-nixos-193406ee7474">this one</a> as well as the <a href="https://nixos.wiki/wiki/Full_Disk_Encryption">NixOS wiki entry</a> on
full disk encryption.
</p>

<p>
The idea is relatively simple : we are going to use a key file (hidden or not in a
partition) to unlock a luks encrypted — with a fallback on passphrase (in case the medium
is not there). There is 3 main steps :
</p>
<ul class="org-ul">
<li>creating the key file and storing it somewhere</li>
<li>add the key to a slot in the luks encrypted partition</li>
<li>configuring NixOS to use it</li>
</ul>
<section id="outline-container-Creating%20a%20keyfile%20and%20storing%20it" class="outline-2">
<h2 id="Creating%20a%20keyfile%20and%20storing%20it">Creating a keyfile and storing it</h2>
<div class="outline-text-2" id="text-Creating%20a%20keyfile%20and%20storing%20it">
<p>
Creating a key file is very simple. If we are to use a file, we can just do the following:
</p>

<div class="org-src-container">
<pre class="src src-bash">$ dd <span class="org-variable-name">if</span>=/dev/urandom <span class="org-variable-name">of</span>=hdd.key <span class="org-variable-name">bs</span>=4096 <span class="org-variable-name">count</span>=1
</pre>
</div>

<p>
I have two key to generate, one for <code>aomi</code> and one for <code>naruhodo</code>
</p>

<div class="org-src-container">
<pre class="src src-bash">$ dd <span class="org-variable-name">if</span>=/dev/random <span class="org-variable-name">of</span>=naruhodo.key.bin <span class="org-variable-name">bs</span>=1 <span class="org-variable-name">count</span>=4096
4096+0 records<span class="org-keyword"> in</span>
4096+0 records out
4096 bytes (4.1 kB, 4.0 KiB) copied, 0.00947718 s, 432 kB/s

$ dd <span class="org-variable-name">if</span>=/dev/random <span class="org-variable-name">of</span>=aomi.key.bin <span class="org-variable-name">bs</span>=1 <span class="org-variable-name">count</span>=4096
4096+0 records<span class="org-keyword"> in</span>
4096+0 records out
4096 bytes (4.1 kB, 4.0 KiB) copied, 0.00985101 s, 416 kB/s
</pre>
</div>

<p>
What we are going to do here is, to hide the key inside a sdcard or a usb stick. The idea
is to use the first or the last few blocks to hide the key.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter"># </span><span class="org-comment">This writes the aomi key to the "head" of sda (a sdcard)</span>
$ sudo dd <span class="org-variable-name">if</span>=sync/aomi.key.bin <span class="org-variable-name">of</span>=/dev/sda <span class="org-variable-name">bs</span>=1 <span class="org-variable-name">count</span>=4096
<span class="org-comment-delimiter"># </span><span class="org-comment">This writes the naruhodo key to the "tail" of sdb (a usb card)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">The offset has to be computed from the usb key size</span>
$ sudo dd <span class="org-variable-name">if</span>=sync/naruhodo.key.bin <span class="org-variable-name">of</span>=/dev/sdb <span class="org-variable-name">bs</span>=1 <span class="org-variable-name">count</span>=4096 <span class="org-variable-name">seek</span>=30992883712
</pre>
</div>
</div>
</section>
<section id="outline-container-Add%20the%20key%20to%20a%20slot" class="outline-2">
<h2 id="Add%20the%20key%20to%20a%20slot">Add the key to a slot</h2>
<div class="outline-text-2" id="text-Add%20the%20key%20to%20a%20slot">
<p>
This is probably the easiest step of all, this is just about running the following.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ cryptsetup luksAddKey $<span class="org-variable-name">LUKS_DEVICE</span> $<span class="org-variable-name">KEY</span>
</pre>
</div>

<p>
The only <i>trick</i> to it is : you have to do this &ldquo;offline&rdquo;, a.k.a. when the partition in
locked (and thus not mounted, …). Either you do this when you are installing the operating
system (and it&rsquo;s straightforward), or you need to boot your laptop/desktop with a livecd
(that also then has access to the key).
</p>
</div>
</section>
<section id="outline-container-NixOS%20configuration" class="outline-2">
<h2 id="NixOS%20configuration">NixOS configuration</h2>
<div class="outline-text-2" id="text-NixOS%20configuration">
<p>
This is where NixOS helps greatly, we have just a few things to write, and NixOS will make
sure all is correctly setup (the initramfs, …).
</p>

<div class="org-src-container">
<pre class="src src-nix"><span class="org-comment-delimiter"># </span><span class="org-comment">For aomi, without offset</span>
<span class="org-nix-attribute">boot.initrd.luks.devices</span> = {
  <span class="org-nix-attribute">root</span> = {
    <span class="org-nix-attribute">device</span> = <span class="org-string">"/dev/disk/by-uuid/{UUID}"</span>;
    <span class="org-nix-attribute">preLVM</span> = <span class="org-nix-builtin">true</span>;
    <span class="org-nix-attribute">allowDiscards</span> = <span class="org-nix-builtin">true</span>;
    <span class="org-nix-attribute">keyFile</span> = <span class="org-string">"/dev/disk/by-id/{DISKID}"</span>;
    <span class="org-nix-attribute">keyFileSize</span> = 4096;
    <span class="org-nix-attribute">fallbackToPassword</span> = <span class="org-nix-builtin">true</span>;
  };
};
<span class="org-comment-delimiter"># </span><span class="org-comment">For narudoho, with offset</span>
<span class="org-nix-attribute">boot.initrd.luks.devices</span> = {
  <span class="org-nix-attribute">root</span> = {
    <span class="org-nix-attribute">device</span> = <span class="org-string">"/dev/disk/by-uuid/{UUID}"</span>;
    <span class="org-nix-attribute">preLVM</span> = <span class="org-nix-builtin">true</span>;
    <span class="org-nix-attribute">allowDiscards</span> = <span class="org-nix-builtin">true</span>;
    <span class="org-nix-attribute">keyFile</span> = <span class="org-string">"/dev/disk/by-id/{DISKID}"</span>;
    <span class="org-nix-attribute">keyFileOffset</span> = 30992883712;
    <span class="org-nix-attribute">keyFileSize</span> = 4096;
    <span class="org-nix-attribute">fallbackToPassword</span> = <span class="org-nix-builtin">true</span>;
  };
};
</pre>
</div>

<p>
Now, we are a <code>nixos-rebuild</code> away from being able to boot a NixOS on a encrypted file
system, without having to type the password <b>if we have the correct medium</b> inserted in
the machine.
</p>

<p>
<i>Of course, this means that the &ldquo;unlock&rdquo; medium becomes precious and important <b>not to</b>
loose. If you go on vacation for example, you should definitely remove any of those medium
and hide them (or bring them with you).</i>
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<footer>
     <small><a href="/" rel="history">Index</a> • <a href="/sitemap.html">Sitemap</a> • <a href="https://dl.sbr.pm/">Files</a></small><br/>
     <small class='questions'>Questions, comments ? Please use my <a href="https://lists.sr.ht/~vdemeester/public-inbox">public inbox</a> by sending a plain-text email to <a href="mailto:~vdemeester/public-inbox@lists.sr.ht">~vdemeester/public-inbox@lists.sr.ht</a>.</small><br/>
     <small class='copyright'>
      Content and design by Vincent Demeester
      (<a rel='licence' href='http://creativecommons.org/licenses/by-nc-sa/3.0/'>Some rights reserved</a>)
    </small><br />
</footer>
</footer>
</body>
</html>
