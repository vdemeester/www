<!DOCTYPE html>
<html lang="en">
<head>
<!-- Sep 03, 2024 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Golang testing — gotest.tools poll</title>
<meta name="author" content="Vincent Demeester" />
<meta name="generator" content="Org Mode" />
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href='/css/new.css' type='text/css'/>
<link rel='stylesheet' href='/css/syntax.css' type='text/css'/>
<link href='/index.xml' rel='alternate' type='application/rss+xml' title='Vincent Demeester' />
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Golang testing — gotest.tools poll</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#Introduction">Introduction</a></li>
<li><a href="#~WaitOn~"><code>WaitOn</code></a></li>
<li><a href="#~Check~%20and%20~Result~"><code>Check</code> and <code>Result</code></a></li>
<li><a href="#Conclusion">Conclusion</a></li>
</ul>
</div>
</nav>
<section id="outline-container-Introduction" class="outline-2">
<h2 id="Introduction">Introduction</h2>
<div class="outline-text-2" id="text-Introduction">
<p>
Let&rsquo;s continue the <a href="https://gotest.tools"><code>gotest.tools</code></a> serie, this time with the <code>poll</code> package.
</p>

<blockquote>
<p>
Package poll provides tools for testing asynchronous code.
</p>
</blockquote>

<p>
When you write test, you may test a piece of code that work asynchronously, where the
state you&rsquo;re expecting is gonna take a bit of time to be achieved. This is especially true
when you work on networking or file-system code. And this happens a lot when you write
integration (or end-to-end) test, less for unit-tests.
</p>

<p>
The package <code>poll</code> is trying to tackle those use cases. We&rsquo;ll first take a look at the
main function, <code>WaitOn</code>, then how to write a <code>Check</code>, using the <code>Result</code> type.
</p>
</div>
</section>
<section id="outline-container-~WaitOn~" class="outline-2">
<h2 id="~WaitOn~"><code>WaitOn</code></h2>
<div class="outline-text-2" id="text-~WaitOn~">
<p>
Let&rsquo;s look into the main <code>poll</code> function : `WaitOn`.
</p>

<blockquote>
<p>
WaitOn a condition or until a timeout. Poll by calling check and exit when check returns
a done Result. To fail a test and exit polling with an error return a error result.
</p>
</blockquote>

<p>
In a gist, <code>WaitOn</code> will run a <i>condition</i> function until it either times out or
succeed. It wait for a given time/delay between each run.
</p>

<div class="org-src-container">
<pre class="src src-go">func WaitOn(t TestingT, check Check, pollOps ...SettingOp) {
        // […]
}
</pre>
</div>

<p>
As any <i>testing helper</i> function, the first argument is <code>*testing.T</code> (or, in this case,
any thing that look like it, thanks to the <code>TestingT</code> interace). The two other arguments
are way more interesting :
</p>

<ul class="org-ul">
<li>The <code>Check</code> is the condition that will run multiple times until it either timeout, or succeed.</li>
<li>The <code>SettingOp(s)</code> which are options to configure the function, things like the timeout,
or the <i>delay</i> between each run.</li>
</ul>

<p>
The settings are pretty straightforward :
</p>

<ul class="org-ul">
<li><code>WithDelay</code> : sets the delay to wait between polls. The default delay is 100ms.</li>
<li><code>WithTimeout</code> : sets the timeout. The default timeout is 10s.</li>
</ul>

<p>
There is existing <code>Check</code> for common case:
</p>

<ul class="org-ul">
<li><p>
<code>Connection</code> : try to open a connection to the address on the named network.
</p>

<div class="org-src-container">
<pre class="src src-go">poll.WaitOn(t, poll.Connection("tcp", "foo.bar:55555"), poll.WithTimeout("5s"))
</pre>
</div></li>

<li><p>
<code>FileExists</code> : looks on filesystem and check that path exists.
</p>

<div class="org-src-container">
<pre class="src src-go">poll.WaitOn(t, poll.FileExists("/should/be/created"), poll.WithDelay("1s"))
</pre>
</div></li>
</ul>
</div>
</section>
<section id="outline-container-~Check~%20and%20~Result~" class="outline-2">
<h2 id="~Check~%20and%20~Result~"><code>Check</code> and <code>Result</code></h2>
<div class="outline-text-2" id="text-~Check~%20and%20~Result~">
<p>
<code>Connection</code> and <code>FileExists</code> are the only two <i>built-in</i> <code>Check</code> provided by
<code>gotest.tools</code>. They are useful, but as usual, where <code>gotest.tools</code> shines is
extensiblity. It is really easy to define your own <code>Check</code>.
</p>

<div class="org-src-container">
<pre class="src src-go">type Check func(t LogT) Result
</pre>
</div>

<p>
A <code>Check</code> is, thus, only a function that takes <code>LogT</code> — which is anything that can log
something, like <code>*testing.T</code> — and return a <code>Result</code>. Let&rsquo;s look at this intersting
<code>Result</code> type.
</p>

<div class="org-src-container">
<pre class="src src-go">type Result interface {
    // Error indicates that the check failed and polling should stop, and the
    // the has failed
    Error() error
    // Done indicates that polling should stop, and the test should proceed
    Done() bool
    // Message provides the most recent state when polling has not completed
    Message() string
}
</pre>
</div>

<p>
Although it&rsquo;s an interface, the <code>poll</code> package defines built-in <code>Result</code> so that it&rsquo;s easy
to write <code>Check</code> without having to define you <code>Result</code> type.
</p>

<ul class="org-ul">
<li><code>Continue</code> returns a Result that indicates to WaitOn that it should continue
polling. The message text will be used as the failure message if the timeout is reached.</li>
<li><code>Success</code> returns a Result where Done() returns true, which indicates to WaitOn that it
should stop polling and exit without an error.</li>
<li><code>Error</code> returns a Result that indicates to WaitOn that it should fail the test and stop
polling.</li>
</ul>

<p>
The basic just to write a <code>Check</code> is then :
</p>

<ul class="org-ul">
<li>if the state is not there yet, return <code>Continue</code>,</li>
<li>if there is an error, unrelated to validating the state, return an <code>Error</code>,</li>
<li>if the state is there, return <code>Success</code>.</li>
</ul>

<p>
Let&rsquo;s look at an example taken from the <code>moby/moby</code> source code.
</p>

<div class="org-src-container">
<pre class="src src-go">poll.WaitOn(t, container.IsInState(ctx, client, cID, "running"), poll.WithDelay(100*time.Millisecond))

func IsInState(ctx context.Context, client client.APIClient, containerID string, state ...string) func(log poll.LogT) poll.Result {
        return func(log poll.LogT) poll.Result {
                inspect, err := client.ContainerInspect(ctx, containerID)
                if err != nil {
                        return poll.Error(err)
                }
                for _, v := range state {
                        if inspect.State.Status == v {
                                return poll.Success()
                        }
                }
                return poll.Continue("waiting for container to be one of (%s), currently %s", strings.Join(state, ", "), inspect.State.Status)
        }
}
</pre>
</div>
</div>
</section>
<section id="outline-container-Conclusion" class="outline-2">
<h2 id="Conclusion">Conclusion</h2>
<div class="outline-text-2" id="text-Conclusion">
<p>
… that&rsquo;s a wrap. The <code>poll</code> package allows to easily wait for a condition to happen in a
given time-frame — with sane defaults. As for most of the <code>gotest.tools</code> package, we use
this package heavily in <code>docker/*</code> projects too…
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<footer>
     <small><a href="/" rel="history">Index</a> • <a href="/sitemap.html">Sitemap</a> • <a href="https://dl.sbr.pm/">Files</a></small><br/>
     <small class='questions'>Questions, comments ? Please use my <a href="https://lists.sr.ht/~vdemeester/public-inbox">public inbox</a> by sending a plain-text email to <a href="mailto:~vdemeester/public-inbox@lists.sr.ht">~vdemeester/public-inbox@lists.sr.ht</a>.</small><br/>
     <small class='copyright'>
      Content and design by Vincent Demeester
      (<a rel='licence' href='http://creativecommons.org/licenses/by-nc-sa/3.0/'>Some rights reserved</a>)
    </small><br />
</footer>
</footer>
</body>
</html>
