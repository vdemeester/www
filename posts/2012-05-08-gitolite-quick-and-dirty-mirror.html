<!DOCTYPE html>
<html lang="en">
<head>
<!-- Sep 03, 2024 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gitolite quick and dirty mirror</title>
<meta name="author" content="Vincent Demeester" />
<meta name="generator" content="Org Mode" />
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href='/css/new.css' type='text/css'/>
<link rel='stylesheet' href='/css/syntax.css' type='text/css'/>
<link href='/index.xml' rel='alternate' type='application/rss+xml' title='Vincent Demeester' />
</head>
<body>
<main id="content" class="content">
<header>
<h1 class="title">Gitolite quick and dirty mirror</h1>
</header><section id="outline-container-Introduction" class="outline-2">
<h2 id="Introduction">Introduction</h2>
<div class="outline-text-2" id="text-Introduction">
<p>
I&rsquo;m running a gitolite <span class="underline">instance</span> on my personal server to manage my repositories
(personnal, private or public) ; and I am quickly going to share with you how I setup a
<span class="underline">quick and dirty</span> mirror feature.
</p>

<p>
First, I am using <b><b>gitolite 3</b></b>. The mirroring we are going to setup is not the
<span class="underline">supported</span> <a href="http://sitaramc.github.com/gitolite/mirroring.html">mirroring <b>built-in</b></a>.  We are going to implement a simplier way to set mirror
thing :
</p>

<ol class="org-ol">
<li>Write a custom gitolite command ; the idea is to be able to write <code>git-config</code> stuff.</li>
<li>Write a hook that take a specific <code>git-config</code> (let say <code>mirror.url</code>) and do a simple
mirroring.</li>
</ol>
</div>
</section>
<section id="outline-container-Gitolite%20commands" class="outline-2">
<h2 id="Gitolite%20commands">Gitolite commands</h2>
<div class="outline-text-2" id="text-Gitolite%20commands">
<p>
Gitolite 3 has been rewritten to be more flexible : <a href="http://sitaramc.github.com/gitolite/g3why.html">Why a completely new version</a>. The
rewrite made it really easy to extend gitolite. <del>I&rsquo;ve fork <a href="https://github.com/vdemeester/gitolite">gitolite</a> on github</del> I&rsquo;ve
created a <a href="http://github.com/vdemeester/vdemeester-gitolite-local-code">repository git</a> to easily add commands to my gitolite instance via <span class="underline">local
code</span>. The gitolite command I wrote is a quick and dirty script in shell to add <code>git
config</code>. The source should speek for itself ; It <span class="underline">should</span> include some way to check if the
given config is not already present in the <code>gitolite-admin</code> configuration file — and so
might be rewritten in <code>Perl</code>.
</p>

<p>
The command is <code>write-git-config</code> because a <code>git-config</code> command already exists
in the built-in commands.
</p>

<div class="org-src-container">
<pre class="src src-bash">#!/bin/sh

# Usage:    ssh git@host write-git-config &lt;repo&gt; &lt;key&gt; &lt;value&gt;
#
# Set git-config value for user-created ("wild") repo.

die() { echo "$@" &gt;&amp;2; exit 1; }
usage() { perl -lne 'print substr($_, 2) if /^# Usage/../^$/' &lt; $0; exit 1; }
[ -z "$1" ] &amp;&amp; [ -z "$2" ] &amp;&amp; [ -z "$3" ] &amp;&amp; usage
[ "$1" = "-h" ] &amp;&amp; usage
[ -z "$GL_USER" ] &amp;&amp; die GL_USER not set

# ----------------------------------------------------------------------
repo=$1; shift
key=$1; shift
value=$1; shift

# this shell script takes arguments that are completely under the user's
# control, so make sure you quote those suckers!

if gitolite query-rc -q WRITER_CAN_UPDATE_DESC
then
    gitolite access -q "$repo" $GL_USER W any || die You are not authorised
else
    gitolite creator "$repo" $GL_USER || die You are not authorised
fi

# if it passes, $repo is a valid repo name so it is known to contain only sane
# characters.  This is because 'gitolite creator' return true only if there
# *is* a repo of that name and it has a gl-creator file that contains the same
# text as $GL_USER.

configfile=`gitolite query-rc GL_REPO_BASE`/"$repo".git/config

git config --file "$configfile" "$key" "$value"
</pre>
</div>
</div>
</section>
<section id="outline-container-Gitolite%20hooks" class="outline-2">
<h2 id="Gitolite%20hooks">Gitolite hooks</h2>
<div class="outline-text-2" id="text-Gitolite%20hooks">
<p>
The next step is to write a quick <code>post-receive</code> hook that check if there is a
certain <code>git-config</code> entry and run <code>git push --mirror</code>. The file is in
<code>$HOME/.gitolite/hooks/common/post-receive</code> ; you could add a better system to
hooks (to be able to add &ldquo;dynamic&rdquo; hooks, …).
</p>

<div class="org-src-container">
<pre class="src src-bash">
#!/bin/sh

# Simple gitolite mirroring

# flush STDIN coming from git, because gitolite's own post-receive.mirrorpush
# script does the same thing
[ -t 0 ] || cat &gt;/dev/null

[ -z "$GL_REPO" ] &amp;&amp; die GL_REPO not set

target=`git config --get mirror.url`
[ -z "$target" ] &amp;&amp; exit 0

# Support a REPO variable for wildcard mirrors
gl_repo_escaped=$(echo $GL_REPO | sed 's/\//\\\//g')
target=$(echo $target | sed -e "s/REPO/$gl_repo_escaped/g")

# Do the mirror push
git push --mirror $target
</pre>
</div>

<p>
The next, and final step is to run `gitolite compile` to update links to hooks
for every repositories.
</p>
</div>
</section>
<section id="outline-container-For%20real" class="outline-2">
<h2 id="For%20real">For real</h2>
<div class="outline-text-2" id="text-For%20real">
<p>
And finaly, this is the final step you&rsquo;ll do.
</p>

<div class="org-src-container">
<pre class="src src-bash">$ ssh git@host write-git-config vincent/vcsh-home mirror.url git@github.com:vdemeester/vcsh-home.git
$ git push
Counting objects: 5, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 294 bytes, done.
Total 3 (delta 2), reused 0 (delta 0)
remote: To git@github.com:vdemeester/vcsh-home.git
remote:    65681a8..701c990  master -&gt; master
To git@host:vincent/vcsh-home.git
   65681a8..701c990  master -&gt; master
</pre>
</div>


<p>
And that should be it !
</p>

<p>
<span class="underline">Update 2012/10/04</span> : Moved from gitolite fork to <span class="underline">gitolite local code</span>
repository.
</p>
</div>
</section>
</main>
<footer id="postamble" class="status">
<footer>
     <small><a href="/" rel="history">Index</a> • <a href="/sitemap.html">Sitemap</a> • <a href="https://dl.sbr.pm/">Files</a></small><br/>
     <small class='questions'>Questions, comments ? Please use my <a href="https://lists.sr.ht/~vdemeester/public-inbox">public inbox</a> by sending a plain-text email to <a href="mailto:~vdemeester/public-inbox@lists.sr.ht">~vdemeester/public-inbox@lists.sr.ht</a>.</small><br/>
     <small class='copyright'>
      Content and design by Vincent Demeester
      (<a rel='licence' href='http://creativecommons.org/licenses/by-nc-sa/3.0/'>Some rights reserved</a>)
    </small><br />
</footer>
</footer>
</body>
</html>
